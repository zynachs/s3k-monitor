#include "test.h"

#include "app.h"
#include "altmem.h"

#include <stdint.h>
#include <string.h>

/* Compiled malicious machine code, created using "make genpayload" */
static const uint8_t code_data[272] = {
    0x01,0x11,0x22,0xec,0x00,0x10,0xb7,0x07,0x00,0x10,0x23,0x34,0xf4,0xfe,0x83,0x37,
    0x84,0xfe,0x13,0x07,0x50,0x04,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,
    0x80,0x07,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x50,0x06,0x23,0x80,
    0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x30,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,
    0x84,0xfe,0x13,0x07,0x50,0x07,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,
    0x40,0x07,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x90,0x06,0x23,0x80,
    0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0xe0,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,
    0x84,0xfe,0x13,0x07,0x70,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,
    0x00,0x02,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x60,0x06,0x23,0x80,
    0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x20,0x07,0x23,0x80,0xe7,0x00,0x83,0x37,
    0x84,0xfe,0x13,0x07,0xf0,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,
    0xd0,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x00,0x02,0x23,0x80,
    0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x40,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,
    0x84,0xfe,0x13,0x07,0x10,0x06,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,
    0x40,0x07,0x23,0x80,0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x10,0x06,0x23,0x80,
    0xe7,0x00,0x83,0x37,0x84,0xfe,0x13,0x07,0x10,0x02,0x23,0x80,0xe7,0x00,0x83,0x37,
    0x84,0xfe,0x29,0x47,0x23,0x80,0xe7,0x00,0x01,0x00,0x62,0x64,0x05,0x61,0x82,0x80
}; /* Output: "Executing from data!" */

static const uint8_t code_out_of_bounds[380] = {
    0x01,0x11,0x22,0xEC,0x00,0x10,0xB7,0x07,0x00,0x10,0x23,0x34,0xF4,0xFE,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x80,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x50,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x90,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xE0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x70,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x00,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x60,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x20,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0xD0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x60,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x00,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x20,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x40,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x10,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x29,0x47,
    0x23,0x80,0xE7,0x00,0x01,0x00,0x62,0x64,0x05,0x61,0x82,0x80
}; /* Output: "Executing from out of bounds!" */

static const uint8_t code_new_code[352] = {
    0x44,0xDF,0xD5,0x04,0x5A,0x89,0x8D,0x1B,0x0E,0xE3,0x21,0x42,0x04,0xF4,0x5A,0x8E, // signature
    0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // size
    0x01,0x11,0x22,0xEC,0x00,0x10,0xB7,0x07,0x00,0x10,0x23,0x34,0xF4,0xFE,0x83,0x37, // code
    0x84,0xFE,0x13,0x07,0x50,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x80,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x50,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x90,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xE0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x70,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x00,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x60,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x20,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0xD0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xE0,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x70,0x05,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x50,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x10,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x29,0x47,0x23,0x80,0xE7,0x00,0x01,0x00,0x62,0x64,0x05,0x61,0x82,0x80
}; /* Output: "Executing from NEW code!" */

static const uint8_t code_broken_sig[352] = {
    0xFF,0xDF,0xD5,0x04,0x5A,0x89,0x8D,0x1B,0x0E,0xE3,0x21,0x42,0x04,0xF4,0x5A,0x8E, // signature
    0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // size
    0x01,0x11,0x22,0xEC,0x00,0x10,0xB7,0x07,0x00,0x10,0x23,0x34,0xF4,0xFE,0x83,0x37, // code
    0x84,0xFE,0x13,0x07,0x50,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x80,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x50,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x90,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xE0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x70,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x00,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x60,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x20,0x07,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0xD0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0xE0,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0x50,0x04,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x70,0x05,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x00,0x02,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x30,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x13,0x07,0xF0,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,
    0x40,0x06,0x23,0x80,0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x50,0x06,0x23,0x80,
    0xE7,0x00,0x83,0x37,0x84,0xFE,0x13,0x07,0x10,0x02,0x23,0x80,0xE7,0x00,0x83,0x37,
    0x84,0xFE,0x29,0x47,0x23,0x80,0xE7,0x00,0x01,0x00,0x62,0x64,0x05,0x61,0x82,0x80
}; /* Output: "Executing from NEW code!" */

static uint8_t arbitrary_data[] = {0xDE,0xAD,0xBE,0xEF};

typedef void (*func_t)(void);

void test1(void) 
{
    /* Write data outside process memory. Expected outcome: EXCEPTION, mcause=7 (store/AMO access fault) */ 
    void * ptr = &_stack_top;
    memcpy(ptr, code_out_of_bounds, sizeof(code_out_of_bounds));
    return;
}

void test2(void) 
{
    /* Calls instruction outside of process memory. Expected outcome: EXCEPTION, mcause=1 (instruction access fault) */
    void * ptr = &_stack_top;
	((func_t)ptr)();
    return;
}

void test3(void) 
{
    /* Write data into .text region. Expected outcome: EXCEPTION, mcause=7 (store/AMO access fault) */ 
    uint64_t addr = (uint64_t)&_text;
    addr += 0x1800; 
    void * ptr = (void*)addr;
    memcpy(ptr, arbitrary_data, sizeof(arbitrary_data));
    return;
}

void test4(void) 
{
    /* Call code_data as a function. Expected outcome: EXCEPTION, mcause=1 (instruction access fault) */ 
	((func_t)code_data)();
    return;
}

void * test5(void)
{
    /* Writes data to heap. Expected outcome: EXCEPTION, mcause=7 (Store/AMO access fault).
       Should be able to recover by creating a new PMP with access. */
    void * ptr = altmem_alloc(sizeof(code_new_code));
    memcpy(ptr, code_new_code, sizeof(code_new_code));
    return ptr;
}

void test6(void * ptr)
{
    /* Attemps to execute code written in test5. Expected outcome: EXCEPTION, mcause=1 (Instruction access fault). Should be able to recover by asking monitor to verify code. */
    uint64_t addr = (uint64_t)ptr;
    addr += 0x20;
    ((func_t)addr)();
    altmem_free(ptr);
    return;
}

void test7(void)
{
    /* Attempts to write new code and execute it, but the signature is broken. Expected outcome: First mcause 7, then mcause 1, recovery soft-reset */
    void * ptr = altmem_alloc(sizeof(code_broken_sig));
    memcpy(ptr, code_broken_sig, sizeof(code_broken_sig));
    uint64_t addr = (uint64_t)ptr;
    addr += 0x20;
    ((func_t)addr)();
    altmem_free(ptr);
    return;
}

void test8(void) 
{
    /* Copies arbitrary data to _rodata. Expected outcome: EXCEPTION, mcause=7 (store/AMO access fault) */
    void * ptr = &_rodata;
    memcpy(ptr, arbitrary_data, 4);

    return;
}

void test9(void)
{
    /* Sets stack pointer to _stack and attempts to push data to stack. Expected outcome: EXCEPTION, mcause=7 (Store/AMO access fault).
       Should be able to recover by creating a new pmp with access behind the scenes. If there is no more space, kill and restart process. */
	__asm__ volatile("addi sp,sp,-1024");
	__asm__ volatile("addi sp,sp,-1024");
	__asm__ volatile("addi sp,sp,-1024");
	__asm__ volatile("addi sp,sp,-1024");
	__asm__ volatile("li t0,0xDEADBEEF");
	__asm__ volatile("addi sp,sp,-32");
	__asm__ volatile("sd t0,0(sp)");
	__asm__ volatile("addi sp,sp,32");
	__asm__ volatile("addi sp,sp,1024");
	__asm__ volatile("addi sp,sp,1024");
	__asm__ volatile("addi sp,sp,1024");
	__asm__ volatile("addi sp,sp,1024");
    return;
}
